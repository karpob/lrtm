#Fit the data!
#from numpy import *
import matplotlib
matplotlib.use('PDF')
from scipy.optimize import leastsq
from residual_enthalpy_data import residual_enthalpy_data
from residual_pXT_data import residual_pXT_data
from calc_enthalpy import calc_enthalpy
from pylab import *
from numpy import *
#  4.68539716e-01   5.67324122e-01   2.40305501e+00   2.35476220e-01
#   2.03766200e+00   2.94051278e-02   8.98553184e-01   1.56431550e+00
#   3.01181288e-02   8.98492821e-01  -4.86994994e+01   4.13644352e+01
#   3.42358026e+01  -2.07093126e+02   1.65860312e+02   3.08042475e+02] 
#p=zeros(16)
MPa_to_kPa=1000.0
Bars_to_kPa=100.0

#p[0]=0.14218447
#p[1]=0.0801219
#p[2]=0.72924574
#p[3]=0.03325274 
            
#1st Ni,ti,di
#p[4]=3.07243966
#p[5]=0.02976093
#p[6]=0.89850581
       
#2nd Ni, ti,di
#p[7]=0.52978115
#p[8]=0.02862252
#p[9]=0.89854406
          
         
#p[0]=1.000000000 
#p[1]=1.018702573 
#p[3]=1.000000000
#p[4]=1.352643115 

#p[5]=-0.25157134971934 
#p[6]=2.000
#p[7]=1

#p[8]=0.62203841111983   
#p[9]=1.000
#p[10]=3 
 
  
#p[10]=0.88850315184396
#p[11]=1.750
#p[12]=3 
 
  
#p[13]=0.35592212573239 
#p[14]=1.400
#p[15]=4 
#
#p=asarray([  6.36311136e-01,   5.67211664e-01,   2.18538832e+00,   1.34644579e-02,
#            -2.52540953e-02,   2.95151464e+01,   4.42740553e+01,   4.46986512e+01,
#             7.31902404e+00,   1.48126421e+00,  -5.83924340e+00,  -9.85045804e-03,
#             2.16727467e+01,  -3.67515727e+01,   6.70734203e+00,   1.30952432e+00] )

#p=asarray(   [  1.38889627e-01,  -4.97936070e-02,   3.44007107e-01,  -5.90253000e-01,
#               -2.34922127e-01,   1.77246208e+01,  -5.04028408e+00,   2.84917374e-06,
#               -3.81438409e-01,  -2.72571731e+00,   7.10452856e-03,  -5.26334325e+02,
#                9.15726242e+02,   5.05934487e-01,   1.63835113e+01,  -5.38243532e+00] 
#)

#p=asarray([  6.36411008e-01,   5.44935854e-01,   2.18505670e+00,   1.35321090e-02,
#            -2.52540953e-02,   2.95151464e+01,   4.42740553e+01,   3.99649045e+01,
#             7.37181455e+00,   1.49523018e+00,  -5.83924340e+00,  -9.85045804e-03,
#             2.16727467e+01,  -3.19588215e+01,   6.67456626e+00,   1.29947781e+00] )
#2nd round
#p=[  6.36258050e-01,   4.48244386e-01,   2.18547420e+00,   1.04147094e-02,
#    -2.52540953e-02,   2.95151464e+01,   4.42740553e+01,   2.86879412e+01,
#     7.58354860e+00,   1.56482938e+00,  -5.83924340e+00,  -9.85045804e-03,
#     2.16727467e+01,  -2.01178754e+01,   6.51029749e+00,   1.25914909e+00] 

#original 
#p=asarray( [  6.53975954e-01,   2.92154267e-01,   2.12661348e+00,   2.99564914e-02,
#             -2.52540953e-02,   2.95151464e+01,   4.42740553e+01,  
#             -3.41906860e+00, 8.72104597e+00,   2.44514844e0,  
#             -5.83924340e+00,  -9.85045804e-03,2.16727467e+01,  
#             -2.94464901e+00,   4.79897828e+00,   9.02523155e-01]) 

#p=asarray([  2.19919789e+00,   4.77268960e-01,  -4.41599239e+00,   9.74108795e-01,
#            -1.26081986e+00,   7.50787513e-01,   2.06090438e+00,  -1.81183218e-09,
#             1.01436493e+01,   3.02510189e+01,  -9.89452150e-02,  -1.11406530e+00,
#             5.70139407e-05,  -1.46858742e-08,  -3.35308681e-01,   1.32121180e+01 ])
#4th Ni, ti, di
#p[13]=1.93489785e+02           
#p[14]=6.67734699
#p[15]=5.50598691


#p=asarray([  8.92450539e+02,   3.70864627e+03,   4.03293048e+03,   4.33448428e+03,
#   1.22254459e+01,  -5.35474826e-01,   6.11512701e-01,  -8.12835557e+03,
#   1.12315678e+01,   4.85989042e+00,   9.18895895e+01,  -7.19941921e-03,
#   6.95260556e-03,   1.27701157e+03,   1.34767172e+01,   4.16828253e+00])

#[  8.92450539e+02   3.70864627e+03   4.03293048e+03   4.33448428e+03
#   1.22254459e+01  -5.35474826e-01   6.11512701e-01  -8.12835557e+03
#   1.12315678e+01   4.85989042e+00   9.18895895e+01  -7.19941921e-03
#   6.95260556e-03   1.27701157e+03   1.34767172e+01   4.16828253e+00]
#p=[  8.924,   0.2,   0.3,   0.4,
#   1.22254459e+01,  -5.35474826e-01,   6.11512701e-01,  -8.12835557e+03,
#   1.12315678e+01,   4.85989042e+00,   9.18895895e+01,  -7.19941921e-03,
#   6.95260556e-03,   1.27701157e+03,   1.34767172e+01,   4.16828253e+00]

#p=asarray([0.35027854,-0.61593331,1.4401281,-0.12750122,7.92247566, -7.37889621,48.18464436,-9.3777652])

#p=asarray([  4.62743073e-01,   9.73148285e-01,   2.01174734e+00,   8.32933973e-01,
#             1.13554111e+00,   1.66033231e+02,  -7.53997710e-01,  -3.67776301e-01,
#            -2.50867607e+00,   8.20806368e-01,  -4.25881541e+00,  -1.33188143e-03,
#             5.72534620e+00,   7.93281165e-03,   5.17685736e+00,   6.59835575e+00])           
#asarray([ 2.93838033,  3.34586718, -1.78430799,  1.87951085,  0.78048593,  0.77314755,
#  2.58808312,  1.76256992]  )
Data_Enthalpy_x_h2=asarray([0.5,0.5,0.5,0.5,0.5,
                            0.5,0.5,0.5,0.5,0.5,
                            0.5,0.5,0.5,0.5,0.5,
                            0.5,0.5,0.5,0.5,0.5,
                            0.5,0.5,0.5,0.5,0.5,
                            0.5,0.5,0.5,0.5,0.5,
                            0.5,0.5,0.5,0.5,0.5,
                            0.5,0.5,0.5,0.5,0.5,
                            0.5,0.5,0.5,0.5,0.5,
                            0.5,0.5,0.5,0.5,0.5,
                            0.5,0.5,0.5,0.5,0.5,
                            0.5,0.5,0.5,0.5,0.5,
                            0.5,0.69,0.588,0.481,0.371,
                            0.263,0.693,0.591,0.482,0.37,
                            0.257])
Data_Enthalpy_x_h2o=1.0-Data_Enthalpy_x_h2
Data_Enthalpy_T=asarray([448.2,473.2,498.2,523.2,548.2,
                         573.2,598.2,598.2,448.2,473.2,
                         498.2,523.2,548.2,573.2,598.2,
                         598.2,448.2,473.2,498.2,523.2,
                         548.2,573.2,598.2,598.2,448.2,
                         473.2,498.2,523.2,548.2,573.2,
                         598.2,598.2,448.2,473.2,498.2,
                         523.2,548.2,573.2,598.2,598.2,
                         648.2,648.2,648.2,648.2,648.2,
                         648.2,648.2,648.2,648.2,648.2,
                         648.2,698.2,698.2,698.2,698.2,
                         698.2,698.2,698.2,698.2,698.2,
                         698.2,598.2,598.2,598.2,598.2,
                         598.2,698.2,698.2,698.2,698.2,
                         698.2])
Data_Enthalpy_PMPa=asarray([0.55,0.68,0.48,1.06,1.47,
                            1.84,2.13,3.88,0.62,0.93,
                            0.7,2,2.93,3.42,5.38,6.88,
                            0.69,0.98,1.22,2.9,3.91,
                            4.84,6.93,8.2,0.76,1.28,
                            2.04,3.31,4.42,6.28,9.27,
                            9.32,0.93,1.34,2.14,3.55,
                            5.13,7.08,9.38,10.69,2.14,
                            4.01,5.88,7.96,9.75,9.89,
                            11.38,11.86,11.89,11.9,12.04,
                            2.09,2.93,4.05,4.96,5.85,
                            7.8,9.2,9.84,11.13,11.9,10.51,
                            10.51,10.51,10.51,10.51,11.13,
                            11.13,11.13,11.13,11.13])

Data_Enthalpy_H=asarray([163,160,75,182,225,
                         247,241,480,194,210,
                         111,386,489,488,710,
                         983,226,254,254,609,
                         706,758,1020,1269,247,
                         349,490,736,873,1103,
                         1555,1646,283,337,524,
                         750,1072,1356,1586,1971,
                         179,365,557,813,1039,
                         1077,1345,1456,1436,1438,
                         1472,149,173,292,321,
                         433,594,687,785,891,
                         992,1482,1783,1990,2025,
                         1789,743,852,941,878,
                         804])
Data_Enthalpy_PkPa=Data_Enthalpy_PMPa*MPa_to_kPa

Data5050_Enthalpy_T=Data_Enthalpy_T[0:61]
Data5050_Enthalpy_P=Data_Enthalpy_PkPa[0:61]/Bars_to_kPa
Data5050_Data_Enthalpy_H=Data_Enthalpy_H[0:61]

sorted_index=Data5050_Enthalpy_T.argsort(axis=0)
Enthalpy_T_sorted=Data5050_Enthalpy_T[sorted_index]
print Enthalpy_T_sorted
Enthalpy_P_sorted=Data5050_Enthalpy_P[sorted_index]
Enthalpy_H_sorted=Data5050_Data_Enthalpy_H[sorted_index]
#for i in range(0,len(Enthalpy_T_sorted)):
#        print i,Enthalpy_T_sorted[i]
#p=asarray([ -2.39988683e-01,  -5.67507832e-02,  -3.43399440e+00,   5.44194356e-02,
#  -8.00207656e+01,   1.86165685e+05,   1.34772817e+01,  -1.81481992e+01,
#   1.35574437e+01,   9.79293834e+00,  -4.11498654e+00,  -1.20523004e+00,
#   2.75811665e+00,  -1.20533998e+00,   4.98924356e+00,   1.46220733e+00,
#   3.80942341e-01,   6.58968592e+00,  -7.62088181e-08,   3.81278639e-01])

#p=asarray([1.55241283,0.42769401,4.27992598,0.96670593,2.85272332,
#           74.01292232,0.62529449,-15.72930264,-123.66329659,7.75795908,
#           9.44061057,78.4079688,0.74614104,2.18500063,2.26700454,
#           -0.19121408,12.50114055,0.80259888,0.19468873,0.53984808])

#p=asarray([  2.38772690e+00,   6.00345713e-01,  -4.76986887e+00,  -5.28153326e-01,
#             1.48640322e+02,   3.37750345e+02,  -8.02065003e-07,  -1.93552324e+01,
#            -1.50381489e+02,  -5.81587781e-01,   2.47064023e-01,  -1.36572784e-02,
#            -7.90363321e-01,   8.74730671e-01,   5.54290051e-01,  -3.98399346e-01,
#             1.18211958e+01,   8.38816225e-01,   0.00000000e+00,   1.00000000e+00,])

#p=[0.97187166,0.44897997,4.82181097,0.24866701,  -1.07509484,
#  -0.66723189,   0.62529449,   3.48571144,  -0.57960654,  18.43986694,
#   0.31975429,  78.4079688,    0.08239091,  -0.69082939,   2.89875517,
#  -0.30605897,  12.50114055,   1.15468121,   0.30899438,   0.31249231]

#p=asarray([  1.70562692,  -5.90404786,   8.28924704,  -3.16312214,
 #            6.61266135e-01,   9.79203977e-01,  -4.67400043e-02,  -4.19925592e-01])
p=asarray([ -1.18010432e+02,  -6.50991719e+05,  -5.31481170e+02,  -4.70133732e+04,
          1.94936672e+00,   1.98910736e+00,  -2.25542574e+00]) 

[optimized_params,message]=leastsq(residual_enthalpy_data,p[:],args=(Data_Enthalpy_H,Data_Enthalpy_PkPa,Data_Enthalpy_T,Data_Enthalpy_x_h2,Data_Enthalpy_x_h2o))
print optimized_params,message
p=optimized_params
#p=asarray([  3.33156256e-01 , -9.06153072e-01,   1.51485197e+00,  -6.73860660e-02,
#   7.57800537e+00,  -6.77750045e+00,   8.28014400e+01,  -1.15396789e+01])

#p=asarray([  3.93176539e+00,   8.45547414e-01,   1.24457365e+00,  -6.99381544e-01,
#             0,   0,  0,  0,
#             0,  0,   0,   0,
#            0,  0,   0])
#p=asarray([0.278735370,  -6.91501101,   1.35464453,  -3.70505658, 6.61469334e-01,   9.79097143e-01,  -4.68079519e-02,  -4.19840850e-01])
x_h2_598_2=asarray(arange(0.01,1.0,0.01))
x_h2_698_2=asarray(arange(0.01,1.0,0.01))


P448=asarray(arange(0.1,1.3,0.1)*MPa_to_kPa)
P473=asarray(arange(0.1,2,0.1)*MPa_to_kPa)
P498=asarray(arange(0.1,3,0.1)*MPa_to_kPa)
P523=asarray(arange(0.1,4,0.1)*MPa_to_kPa)
P548=asarray(arange(0.1,6,0.1)*MPa_to_kPa)
P573=asarray(arange(0.1,8.5,0.1)*MPa_to_kPa)
P598=asarray(arange(0.1,11,0.1)*MPa_to_kPa)
P648=asarray(arange(0.1,13,0.1)*MPa_to_kPa)
P698=asarray(arange(0.1,13,0.1)*MPa_to_kPa)

P_598_2=10.51*MPa_to_kPa*ones(shape(x_h2_598_2))
P_698_2=11.13*MPa_to_kPa*ones(shape(x_h2_698_2))

T448=448.2*ones(shape(P448))
T473=473.2*ones(shape(P473))
T498=498.2*ones(shape(P498))
T523=523.2*ones(shape(P523))
T548=548.2*ones(shape(P548))
T573=573.2*ones(shape(P573))
T598=598.2*ones(shape(P598))
T648=648.2*ones(shape(P648))
T698=698.2*ones(shape(P698))

T_598_2=598.2*ones(shape(P_598_2))
T_698_2=698.2*ones(shape(P_698_2))

x_h2_448=0.5*ones(shape(P448))
x_h2_473=0.5*ones(shape(P473))
x_h2_498=0.5*ones(shape(P498))
x_h2_523=0.5*ones(shape(P523))
x_h2_548=0.5*ones(shape(P548))
x_h2_573=0.5*ones(shape(P573))
x_h2_598=0.5*ones(shape(P598))
x_h2_648=0.5*ones(shape(P648))
x_h2_698=0.5*ones(shape(P698))

x_h2o_698_2=1.0-x_h2_698_2
x_h2o_598_2=1.0-x_h2_598_2

Curve_448=calc_enthalpy(p,P448,T448,x_h2_448,x_h2_448)
Curve_473=calc_enthalpy(p,P473,T473,x_h2_473,x_h2_473)
Curve_498=calc_enthalpy(p,P498,T498,x_h2_498,x_h2_498)
Curve_523=calc_enthalpy(p,P523,T523,x_h2_523,x_h2_523)
Curve_548=calc_enthalpy(p,P548,T548,x_h2_548,x_h2_548)
Curve_573=calc_enthalpy(p,P573,T573,x_h2_573,x_h2_573)
Curve_598=calc_enthalpy(p,P598,T598,x_h2_598,x_h2_598)
Curve_648=calc_enthalpy(p,P648,T648,x_h2_648,x_h2_648)
Curve_698=calc_enthalpy(p,P698,T698,x_h2_698,x_h2_698)

Curve_698_2=calc_enthalpy(p,P_698_2,T_698_2,x_h2_698_2,x_h2o_698_2)
Curve_598_2=calc_enthalpy(p,P_598_2,T_598_2,x_h2_598_2,x_h2o_598_2)

figure(1)
plot(P448/Bars_to_kPa,Curve_448,'r--',label='448 K')
plot(P473/Bars_to_kPa,Curve_473,'g--',label='473 K')
plot(P498/Bars_to_kPa,Curve_498,'b',label='498 K')
plot(P523/Bars_to_kPa,Curve_523,'k',label='523 K')

plot(P548/Bars_to_kPa,Curve_548,'c', label='548 K')
plot(P573/Bars_to_kPa,Curve_573,'m', label='573 K')
plot(P598/Bars_to_kPa,Curve_598,'y', label='598 K')
plot(P648/Bars_to_kPa,Curve_648,'r', label='648 K')
plot(P698/Bars_to_kPa,Curve_698,'g', label='698 K')

errorbar(Enthalpy_P_sorted[0:5],Enthalpy_H_sorted[0:5],yerr=0.02*Enthalpy_H_sorted[0:5],ecolor='r',fmt=None)
errorbar(Enthalpy_P_sorted[5:10],Enthalpy_H_sorted[5:10],yerr=0.02*Enthalpy_H_sorted[5:10],ecolor='g',fmt=None)
errorbar(Enthalpy_P_sorted[10:15],Enthalpy_H_sorted[10:15],yerr=0.02*Enthalpy_H_sorted[10:15],ecolor='b',fmt=None)
errorbar(Enthalpy_P_sorted[15:20],Enthalpy_H_sorted[15:20],yerr=0.02*Enthalpy_H_sorted[15:20],ecolor='k',fmt=None)

errorbar(Enthalpy_P_sorted[20:25],Enthalpy_H_sorted[20:25],yerr=0.02*Enthalpy_H_sorted[20:25],ecolor='c',fmt=None)
errorbar(Enthalpy_P_sorted[25:30],Enthalpy_H_sorted[25:30],yerr=0.02*Enthalpy_H_sorted[25:30],ecolor='m',fmt=None)
errorbar(Enthalpy_P_sorted[30:40],Enthalpy_H_sorted[30:40],yerr=0.02*Enthalpy_H_sorted[30:40],ecolor='y',fmt=None)
errorbar(Enthalpy_P_sorted[40:51],Enthalpy_H_sorted[40:51],yerr=0.02*Enthalpy_H_sorted[40:51],ecolor='r',fmt=None)
errorbar(Enthalpy_P_sorted[51:61],Enthalpy_H_sorted[51:61],yerr=0.02*Enthalpy_H_sorted[51:61],ecolor='g',fmt=None)
legend(loc='upper left')
xlabel('Pressure (bars)')
ylabel('Excess Enthalpy (J/Mol)')
title('Excess Enthalpy 50/50 H$_2$/H$_2$O')
savefig('fun2.pdf',papertype='letter')

figure(2)
plot(1-x_h2o_598_2,Curve_598_2,'b',label='598.2 K, 10.51 MPa')
plot(1-x_h2o_698_2,Curve_698_2,'r',label='698.2 K, 11.13 MPa' )
errorbar(Data_Enthalpy_x_h2[61:66],Data_Enthalpy_H[61:66],yerr=0.02*Data_Enthalpy_H[61:66],ecolor='b',fmt=None)
errorbar(Data_Enthalpy_x_h2[66:len(Data_Enthalpy_x_h2)],Data_Enthalpy_H[66:len(Data_Enthalpy_x_h2)],yerr=0.02*Data_Enthalpy_H[66:len(Data_Enthalpy_x_h2)],ecolor='r',fmt=None)
legend(loc='upper right')
xlabel('Mole Fraction X$_{H_2}$')
ylabel('Excess Enthalpy (J/mol)')
title('Excess Enthalpy for Increasing X$_{H_2}$')
savefig('fun3.pdf',papertype='letter')

